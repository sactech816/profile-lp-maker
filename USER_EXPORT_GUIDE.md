# ユーザー情報エクスポート機能 - 使い方ガイド

## 概要

管理者専用の機能として、登録されたユーザーの情報をCSVファイルでダウンロードしたり、Googleスプレッドシートに自動転送したりできます。

## 利用できる人

- `lib/constants.js`の`ADMIN_EMAIL`に設定されたメールアドレスでログインしたユーザーのみ

## 機能

### 1. CSVダウンロード

**特徴:**
- ワンクリックで全ユーザー情報をCSVファイルとしてダウンロード
- Excelで開ける形式（BOM付きUTF-8）
- 追加設定不要

**使い方:**
1. 管理者アカウントでログイン
2. ダッシュボードを開く
3. 左側のサイドバーにある「ユーザー情報エクスポート」セクションを確認
4. 「CSVダウンロード」ボタンをクリック
5. `users_YYYY-MM-DD.csv`というファイルがダウンロードされます

**ダウンロードされるデータ:**

| 項目 | 説明 |
|------|------|
| ユーザーID | 一意のユーザー識別子 |
| メールアドレス | 登録メールアドレス |
| 登録日時 | アカウント作成日時 |
| 最終ログイン日時 | 最後にログインした日時 |
| メール確認日時 | メールアドレス確認完了日時 |
| 診断クイズ作成数 | ユーザーが作成した診断クイズの数 |
| 診断クイズ購入数 | 診断クイズのPro機能購入回数 |
| LPプロフィール作成数 | ユーザーが作成したLPプロフィールの数 |
| LPプロフィール購入数 | LPプロフィールのPro機能購入回数 |

**CSVファイル名:** `users_YYYY-MM-DD.csv`

### 2. Googleスプレッドシート連携

**特徴:**
- ワンクリックで全ユーザー情報をGoogleスプレッドシートに送信
- スプレッドシート上でデータを管理・分析可能
- 既存データを自動更新（最新の状態を保持）

**使い方:**
1. 事前に`GOOGLE_SHEETS_SETUP.md`の手順に従って設定を完了
2. 管理者アカウントでログイン
3. ダッシュボードを開く
4. 左側のサイドバーにある「ユーザー情報エクスポート」セクションを確認
5. 「スプレッドシートに送信」ボタンをクリック
6. Googleスプレッドシートにデータが追加されます

**初回セットアップ:**
- `GOOGLE_SHEETS_SETUP.md`を参照
- Google Apps Scriptの設定が必要（約10分）
- 環境変数`GOOGLE_SHEETS_WEBHOOK_URL`の設定が必要

## セキュリティ

### アクセス制限
- 管理者アカウント（`ADMIN_EMAIL`）のみがこの機能を利用可能
- APIエンドポイントでも管理者チェックを実施
- 認証トークンの検証を実施

### データ保護
- Supabaseのサービスロールキーを使用して安全にデータを取得
- CSVファイルはローカルにのみ保存
- Googleスプレッドシートの共有設定に注意

## トラブルシューティング

### CSVダウンロードができない

**症状:** ボタンをクリックしてもダウンロードが開始されない

**解決方法:**
1. 管理者アカウントでログインしているか確認
2. ブラウザのコンソールでエラーメッセージを確認
3. 環境変数`SUPABASE_SERVICE_ROLE_KEY`が正しく設定されているか確認

### Googleスプレッドシートに送信できない

**症状:** 「Google Sheets Webhook URL not configured」エラー

**解決方法:**
1. 環境変数`GOOGLE_SHEETS_WEBHOOK_URL`が設定されているか確認
2. Vercelの場合、環境変数を追加後に再デプロイが必要
3. `GOOGLE_SHEETS_SETUP.md`の手順を再確認

**症状:** データが送信されない

**解決方法:**
1. Google Apps ScriptのウェブアプリURLが正しいか確認
2. Apps Scriptのデプロイ設定で「アクセスできるユーザー」が「全員」になっているか確認
3. Googleスプレッドシートが正しく開けるか確認

### 権限エラー

**症状:** 「Admin access required」エラー

**解決方法:**
1. `lib/constants.js`の`ADMIN_EMAIL`を確認
2. 正しい管理者メールアドレスでログインしているか確認
3. 大文字・小文字の違いに注意

## 技術仕様

### API エンドポイント

#### `/api/export-users-csv` (GET)
- 全ユーザー情報をCSV形式で返す
- 認証: Bearer トークン（必須）
- 権限: 管理者のみ

#### `/api/export-users-sheets` (POST)
- 全ユーザー情報をGoogleスプレッドシートに送信
- 認証: Bearer トークン（必須）
- 権限: 管理者のみ

### 環境変数

```bash
# 必須（既存）
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# オプション（Googleスプレッドシート連携用）
GOOGLE_SHEETS_WEBHOOK_URL=https://script.google.com/macros/s/.../exec
```

## よくある質問

**Q: 管理者を複数人設定できますか？**
A: 現在の実装では1人のみです。複数人にする場合は、`lib/constants.js`を配列に変更し、チェックロジックを修正する必要があります。

**Q: 定期的に自動でエクスポートできますか？**
A: Vercel Cronなどを使用して実装可能です。詳細は`GOOGLE_SHEETS_SETUP.md`の「定期的な自動エクスポート」セクションを参照してください。

**Q: エクスポートしたデータを削除できますか？**
A: CSVファイルはローカルに保存されるため、手動で削除できます。Googleスプレッドシートのデータは、スプレッドシート上で手動で削除してください。

**Q: 個人情報保護は大丈夫ですか？**
A: 管理者のみがアクセスできるよう制限されていますが、エクスポートしたデータの取り扱いには十分注意してください。特にGoogleスプレッドシートの共有設定に注意が必要です。

## サポート

問題が解決しない場合は、以下のドキュメントも参照してください：
- `GOOGLE_SHEETS_SETUP.md` - Googleスプレッドシート連携の詳細設定
- `README.md` - プロジェクト全体の設定ガイド

